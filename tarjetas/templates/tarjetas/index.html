{% extends "base.html" %}
{% load i18n %}
{% load static %}
{% block title %}Gestor IMV{% endblock %}
{% block head%}
<meta http-equiv="refresh" content="5;  "/>
{% endblock %}
{% block content %}
<div style="text-align: center;">
<h1>{{ descripcion}}, Total Tarjetas: {{tarjetas_count}}</h1>
</div>
<div class="contenedor">
    <div class="row">
        <div class="col-md-9">
            <div map="map" id="map" style="width: 100%; height: 800px;"></div>
        </div>
    </div>
</div>
<script>
  var latitud = {{ latitud }}; // Obtén la latitud del contexto
  var longitud = {{ longitud }}; // Obtén la longitud del contexto
  // Crea el mapa y establece las coordenadas del centro y el nivel de zoom
  var map = L.map('map').setView([latitud, longitud], 17.5);
  // Agrega el proveedor de mapas (por ejemplo, OpenStreetMap)
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors',
    maxZoom: 30,
  }).addTo(map);
  // Agrega un marcador en las coordenadas del centro
  //L.marker([latitud, longitud]).addTo(map).bindPopup('{{ nombre }}').openPopup();
  let equipos = JSON.parse(document.getElementById('equipos').textContent);
  for (var i = 0; i < equipos.length; i++) {
      var popup = equipos[i].nombre;
      var estado = equipos[i].estado;
      var observaciones = equipos[i].observaciones;
  
      //L.marker([equipos[i].latitud, equipos[i].longitud]).bindPopup(popup).addTo(map); el icono por defecto
      if (estado == 'Operativo'){
        var customIcon = L.divIcon({
        className: 'custom-icon',
        html: '<div class="custom-marker-operativo">' + popup + '</div>',
        iconSize: [100, 20]
        });
        L.marker([equipos[i].latitud, equipos[i].longitud], {icon: customIcon}).bindPopup(observaciones).addTo(map);
        }
      else if (estado == 'Colapsado'){
        var customIcon = L.divIcon({
        className: 'custom-icon',
        html: '<div class="custom-marker-colapsado">' + popup + '</div>',
        iconSize: [100, 20]
        });
        L.marker([equipos[i].latitud, equipos[i].longitud], {icon: customIcon}).bindPopup(observaciones).addTo(map);
        }
      else if (estado == 'Traslado'){
        var customIcon = L.divIcon({
        className: 'custom-icon',
        html: '<div class="custom-marker-traslado">' + popup + '</div>',
        iconSize: [100, 20]
        });
        L.marker([equipos[i].latitud, equipos[i].longitud], {icon: customIcon}).bindPopup(observaciones).addTo(map);
        }
      else if (estado == 'Atendiendo'){
        var customIcon = L.divIcon({
        className: 'custom-icon',
        html: '<div class="custom-marker-atendiendo">' + popup + '</div>',
        iconSize: [100, 20]
        });
        L.marker([equipos[i].latitud, equipos[i].longitud], {icon: customIcon}).bindPopup(observaciones).addTo(map);
        }
      else if (estado == 'No operativo'){
        var customIcon = L.divIcon({
        className: 'custom-icon',
        html: '<div class="custom-marker-nooperativo">' + popup + '</div>',
        iconSize: [100, 20]
        });
        L.marker([equipos[i].latitud, equipos[i].longitud], {icon: customIcon}).bindPopup(observaciones).addTo(map);
        }
      else{
        L.marker([equipos[i].latitud, equipos[i].longitud]).addTo(map);
        }
  }
  //console.log('Hello from main.js');
  // se conecta al websocket
  // Si es http usa wss y sino ws
  var protocol = window.location.protocol === "https:" ? "wss://" : "ws://";
  var socket = new WebSocket(protocol + window.location.host + "/ws/TableData/");
  socket.onmessage = function(e) {
    var data = JSON.parse(e.data);
    var equiposActualizados = data.equipos;
    console.log(data);
    console.log(data.inters_count_open);
    // REfresca los Equipos en el mapa
    	agregarMarcadores(equiposActualizados);
    // Refresca la tabla de las interveciones
    var intersTable = document.getElementById("tabla1-container");
    var newTableHTML = `
    <div id="tabla1-container" class="table-container">
      <h3>Interveciones abiertas: ${data.inters_count_open}</h3>
      <table class="table table-striped table-hover">
        <thead class="table-primary">
            <tr>
              <td>ID</td> 
              <td>Lugar del suceso</td>
              <td>Diagnostico</td>
              <td>Equipo</td>
            </tr>
        </thead>
      </thead>
        <tbody>
              `;

for (var i = 0; i < data.inters.length; i++) {
    var inter = data.inters[i];
    newTableHTML += `
        <tr>
            <td><a class="nav-link text-info fw-bold" href="/myapp/inter_edit/${inter.id}">${inter.num_inter}</a></td>
            <td>${inter.lugar_suceso}</td>
            <td>
                ${inter.triaje_ini === 'VERDE' ?
                    '<span class="badge badge-success">' + inter.patologia + '</span>' :
                    (inter.triaje_ini === 'AMARILLO' ?
                        '<span class="badge badge-warning">' + inter.patologia + '</span>' :
                        (inter.triaje_ini === 'ROJO' ?
                            '<span class="badge badge-danger">' + inter.patologia + '</span>' :
                            inter.patologia))
                }
            </td>
            <td>
              ${inter.solicita_traslado === true && inter.traslado_por === null ?
                  '<span class="badge bg-danger">' + inter.equipo + '</span>' :
                  inter.equipo}
          </td>
        </tr>
    `;
}

newTableHTML += `
        </tbody>
      </table>
    </div>`;

    // ...
    intersTable.innerHTML = newTableHTML;
// REfresca la tabla de los vehiculos
var intersTable = document.getElementById("tabla2-container");
var newTableHTML = `
    <div id="tabla2-container" class="table-container">
      <table class="table table-striped table-hover">
        <thead class="table-primary">
            <tr>
              <td>Vehiculo</td>
              <td>Estado</td>
            </tr>
        </thead>
        <tbody>
    `;

for (var i = 0; i < data.vehiculos.length; i++) {
    var vehiculo = data.vehiculos[i];
    newTableHTML += `
        <tr>
            <td>${vehiculo.indicativo}</td>
            <td>
                ${vehiculo.estado === 'Operativo' ?
                    '<span class="badge badge-success">Operativo</span>' :
                    (vehiculo.estado === 'Traslado' ?
                        '<span class="badge badge-primary">Traslado</span>' :
                        (vehiculo.estado === 'No operativo' ?
                            '<span class="badge badge-secondary">No operativo</span>' :
                            ''))}
            </td>
        </tr>
    `;
}

newTableHTML += `
        </tbody>
      </table>
    </div>
`;

intersTable.innerHTML = newTableHTML;

  }
function agregarMarcadores(equipos) {
     // Borrar los eqipos
    map.eachLayer(function (layer) {
      if (layer instanceof L.Marker) {
          map.removeLayer(layer);
      }
    });
    equipos.forEach(function (equipo) {
      var popup = equipo.nombre;
      var estado = equipo.estado;
      var observaciones = equipo.observaciones;
      if (estado == 'Operativo'){
        var customIcon = L.divIcon({
        className: 'custom-icon',
        html: '<div class="custom-marker-operativo">' + popup + '</div>',
        iconSize: [100, 20]
        });
	    L.marker([equipo.latitud, equipo.longitud], {icon: customIcon}).bindPopup(observaciones).addTo(map);
	    }
      else if (estado == 'Colapsado'){
        var customIcon = L.divIcon({
        className: 'custom-icon',
        html: '<div class="custom-marker-colapsado">' + popup + '</div>',
        iconSize: [100, 20]
        });
        L.marker([equipo.latitud, equipo.longitud], {icon: customIcon}).bindPopup(observaciones).addTo(map);
        }
      else if (estado == 'Traslado'){
        var customIcon = L.divIcon({
        className: 'custom-icon',
        html: '<div class="custom-marker-traslado">' + popup + '</div>',
        iconSize: [100, 20]
        });
        L.marker([equipo.latitud, equipo.longitud], {icon: customIcon}).bindPopup(observaciones).addTo(map);
        }
      else if (estado == 'Atendiendo'){
        var customIcon = L.divIcon({
        className: 'custom-icon',
        html: '<div class="custom-marker-atendiendo">' + popup + '</div>',
        iconSize: [100, 20]
        });
        L.marker([equipo.latitud, equipo.longitud], {icon: customIcon}).bindPopup(observaciones).addTo(map);
        }
      else if (estado == 'No operativo'){
        var customIcon = L.divIcon({
        className: 'custom-icon',
        html: '<div class="custom-marker-nooperativo">' + popup + '</div>',
        iconSize: [100, 20]
        });
        L.marker([equipo.latitud, equipo.longitud], {icon: customIcon}).bindPopup(observaciones).addTo(map);
        }
      else{
        L.marker([equipo.latitud, equipo.longitud]).addTo(map);
        }
  });
}
</script>
<style>
  .custom-marker-colapsado {
    background-color: #ff0000;
    color: #fff;
    padding: 5px;
    border-radius: 5px;
    text-align: center;
    font-weight: bold;
  }
  .custom-marker-operativo {
    background-color: #00ff00;
    color: #000000;
    padding: 5px;
    border-radius: 5px;
    text-align: center;
    font-weight: bold;
  }
  .custom-marker-traslado {
    background-color: #0000ff;
    color: #fff;
    padding: 5px;
    border-radius: 5px;
    text-align: center;
    font-weight: bold;
  }
  .custom-marker-atendiendo {
    background-color: #00ffff;
    color: #000000;
    padding: 5px;
    border-radius: 5px;
    text-align: center;
    font-weight: bold;
  }
  .custom-marker-nooperativo {
    background-color: #000000;
    color: #ffffff;
    padding: 5px;
    border-radius: 5px;
    text-align: center;
    font-weight: bold;
  }
  .table td {
    max-width: 145px; /* Ajusta el valor para el ancho máximo deseado */
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  .table-container {
    max-height: 600px; /* Ajusta la altura máxima deseada */
    overflow-y: auto;
    overflow-x: hidden;}
</style>

{% endblock %}


























