{% extends "base.html" %}
{% load i18n %}

{% block content %}
    <div id="tarjetas-count-container">
      <h1>Total de Tarjetas: {{ tarjetas_count }} </h1>
    </div> 
    <div id="tabla1-container" class="table-container">
      <h3>tarjetas abiertas: {{tarjetas_count_open}}</h3>
      <table id="tabla1" class="table table-striped table-hover">
          <thead class="table-primary">
            <tr>
              <td>Hora</td>
              <td>Num de Tarjeta</td>
              <td>Edad</td>
              <td>Sexo</td>
              <td>Triaje</td>
              <td>Patologia</td>
              <td>Traslada a</td>
              <td>Traslada por</td>
              <td>PSA</td>
              <td>Posicion en el PSA</td>
          </tr>
          </thead>
          <tbody>
                  {% for tarjeta in tarjetas %}
                  <tr>
                    <td>{{tarjeta.hora_ini}}</td>  
                    <td><a class="nav-link text-info fw-bold" href="tarjetas/tarjeta_edit/{{ tarjeta.id }}">{{tarjeta.num_t}}</a></td>
                    <td>{{tarjeta.edad}}</td>
                    <td>{{tarjeta.sexo}}</td>
                    <td>{{tarjeta.triaje}}</td>
                    <td>{{tarjeta.patogia}}</td>
                    <td>{{tarjeta.traslada_a}}</td>
                    <td>{{tarjeta.traslada_por}}</td>
                    <td>{{tarjeta.psa}}</td>
                    <td>{{tarjeta.pas_psa}}</td>
                  </tr>
                  {% endfor %}
          </tbody>
      </table>
    </div>
{% comment %} Script para el datatable {% endcomment %}
    <script>
      $(document).ready(function() {
          $('#tabla1').DataTable();
      } );
  </script>
  <script>
    //console.log('Hello from main.js');
    // se conecta al websocket
    // Si es http usa wss y sino ws
    var protocol = window.location.protocol === "https:" ? "wss://" : "ws://";
    var socket = new WebSocket(protocol + window.location.host + "/ws/TableData/");
    socket.onmessage = function(e) {
      var data = JSON.parse(e.data);
      var tarjetas = data.tarjetas;
      console.log(data);
      console.log(tarjetas);
      console.log(data.tarjetas_count_open);
      // Actualiza el contador de tarjetas
      var tarjetasCountContainer = document.getElementById("tarjetas-count-container");
      tarjetasCountContainer.innerHTML = `<h1>Total de tarjetas: ${data.tarjetas_count}</h1>`;
      // Refresca la tabla de las tarjetas
      var tarjetasTable = document.getElementById("tabla1-container");
      var newTableHTML = `
      <div id="tabla1-container" class="table-container">
        <h3>tarjetas abiertas: ${data.tarjetas_count_open}</h3>
        <table class="table table-striped table-hover">
          <thead class="table-primary">
            <tr>
              <td>Hora</td>
              <td>Num de Tarjeta</td>
              <td>Edad</td>
              <td>Sexo</td>
              <td>Triaje</td>
              <td>Patologia</td>
              <td>Traslada a</td>
              <td>Traslada por</td>
              <td>PSA</td>
              <td>Posicion en el PSA</td>
          </tr
          </thead>
        </thead>
          <tbody>
                `;
  
  for (var i = 0; i < data.tarjetas.length; i++) {
      var tarjeta = data.tarjetas[i];
      console.log(tarjeta)
      newTableHTML += `
          <tr>
            <td>${tarjeta.hora_ini}</td>    
            <td><a class="nav-link text-info fw-bold" href="/tarjetas/tarjeta_edit/${tarjeta.id}">${tarjeta.num_t}</a></td>
            <td>${tarjeta.edad}</td>
            <td>${tarjeta.sexo}</td>
            <td>${tarjeta.triaje}</td>
            <td>${tarjeta.patologia}</td>
            <td>${tarjeta.traslado_a}</td>
            <td>${tarjeta.traslado_por}</td>
            <td>${tarjeta.psa}</td>
            <td>${tarjeta.pos_psa}</td>
          </tr>
      `;
  }
  newTableHTML += `
          </tbody>
        </table>
      </div>`;
  
      // ...
      tarjetasTable.innerHTML = newTableHTML;
  }


</script>

  <style>
      .table td {
          max-width: 145px;
          overflow: hidden;
          text-overflow: ellipsis;
          white-space: nowrap;
      }
  </style>
  {% endblock content %}
